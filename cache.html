<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Parking Availability</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; }
    #availability { color: #fff; font-size: 70px; font-weight: 700; text-align: right; padding: 20px; }
  </style>
</head>
<body>
  <div id="availability">Laden...</div>

  <script>
    const URL = "https://capacity.cegeka.com/api/v1.0/GetParkingAvailability/poml;paren";
    const CACHE_KEY = "parkingAvailability";
    const MAX_AGE_MS = 5 * 60 * 1000; // 5 minuten

    function readCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function writeCache(value) {
      const payload = { value, ts: Date.now() };
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(payload)); } catch {}
      return payload;
    }

    async function fetchAvailability() {
      const res = await fetch(URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Netwerkfout: " + res.status);
      const data = await res.json();
      // Veilig uitlezen; fallback naar null als structuur anders is
      const value = Number(
        data?.data?.[0]?.availability ?? NaN
      );
      if (!Number.isFinite(value)) throw new Error("Ongeldige data");
      return value;
    }

    async function init() {
      const el = document.getElementById("availability");
      const cached = readCache();
      const isFresh = cached && (Date.now() - cached.ts) < MAX_AGE_MS;

      if (isFresh) {
        // toon cached en stop (geen fetch nodig)
        el.textContent = cached.value;
        return;
      }

      // Geen cache of te oud → ophalen
      try {
        const value = await fetchAvailability();
        writeCache(value);
        el.textContent = value;
      } catch (err) {
        console.error(err);
        // Als ophalen faalt maar we hebben wél oude cache, toon die als fallback
        if (cached) {
          el.textContent = cached.value;
        } else {
          el.textContent = "Error";
        }
      }
    }

    init();
  </script>
</body>
</html>

